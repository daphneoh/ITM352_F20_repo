<head>
  <script src="./functions.js"></script>

  <script>
    // get the query string
    let params = (new URL(document.location)).searchParams;
    if (params.has('products_key')) {
      var products_key = params.get('products_key');
    } else {
      //document.write('no products key in query string');
      document.stop;
    }


    var products_data;
    loadJSON('get_products_data', function (response) {
      // Parsing JSON string into object
      products_data = JSON.parse(response);
    });
    var cart;
    loadJSON('get_cart_data', function (response) {
      // Parsing JSON string into object
      cart = JSON.parse(response);
    });
    function Update_Qty(amt, the_indx) {
      document.getElementById(`quantity${the_indx}_messagediv`).innerHTML = "";
      the_indx = Number.parseInt(the_indx);
      var product_qty = Number.parseInt(document.getElementById("quantity" + the_indx).innerHTML);
      if (product_qty > 0 || amt > 0) {
        product_qty += amt;
        document.getElementById("quantity" + the_indx).innerHTML = product_qty;
        UpdateCart(pk, the_indx, product_qty);
      }

    };

    function UpdateCart(products_key, product_index, quantity) {

      data = {
        "products_key": products_key,
        "product_index": product_index,
        "quantity": quantity
      };

      fetch("/update_cart",
        {
          headers: {
            'Content-Type': 'application/json'
          },
          method: "POST",
          body: JSON.stringify(data)
        })
        .then(function (res) { return res.json(); })
        .then(function (data) {
          document.getElementById(`quantity${product_index}_messagediv`).innerHTML = data.message;
        })


    }




  </script>
</head>

<html lang="en">

<head>
  <script src="./functions.js"></script>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="cart-style.css">
  <title>Basket</title>
</head>

<body>
  <main>
    <div class="basket">
      <div class="collapse navbar-collapse" id="myNavbar">
        <ul class="nav navbar-nav">
          <script>nav_bar(products_key, products_data);</script>
        </ul>
        <ul class="nav navbar-nav navbar-right">
          <li><a href="./login_page.html"><span class="glyphicon glyphicon-shopping-cart"></span> Login</a></li>
        </ul>
      </div>
      <div class="basket-labels">
        <ul>
          <li class="item item-heading">Item</li>
          <li class="price">Price</li>
          <li class="quantity">Quantity</li>
          <li class="subtotal">Subtotal</li>
        </ul>
      </div>
      <script>
        for (pk in cart) {
          for (i in cart[pk]) {
            qty = cart[pk][i];
            if (qty > 0) {

              ext_price = qty * products_data[pk][i]["price"];
              document.write(`
      <div class="basket-product">
        <div class="item">
          <div class="product-image">
            <img src=${products_data[pk][i]["image"]} alt="Placholder Image 2" class="product-frame">
          </div>
          <div class="product-details">
            <h1><strong>${products_data[pk][i]["name"]}</h1>
          </div>
        </div>
        <div class="price">${products_data[pk][i]["price"].toFixed(2)}</div>
        <div class = "quantity"><input type = "button" value = "-" onclick="Update_Qty(-1, ${i});">
          <id = "quantity${i}">${qty}
          <input type = "button" value = "+" onclick="Update_Qty(1, ${i});">
          </div>
        <div class="subtotal">104.00</div>
        <div class="remove">
          <button>Remove</button>
        </div>
      </div>`);
            }
          }
        }
      </script>
    </div>
    <aside>
      <div class="summary">
        <div class="summary-total-items"><span class="total-items"></span> Items in your Bag</div>
        <div class="summary-subtotal">
          <div class="subtotal-title">Subtotal</div>
          <div class="subtotal-value final-value" id="basket-subtotal">130.00</div>
          <div class="summary-promo hide">
            <div class="promo-title">Promotion</div>
            <div class="promo-value final-value" id="basket-promo"></div>
          </div>
        </div>
        <div class="summary-delivery">
          <select name="delivery-collection" class="summary-delivery-selection">
            <option value="0" selected="selected">Select Collection or Delivery</option>
            <option value="collection">Collection</option>
            <option value="first-class">Royal Mail 1st Class</option>
            <option value="second-class">Royal Mail 2nd Class</option>
            <option value="signed-for">Royal Mail Special Delivery</option>
          </select>
        </div>
        <div class="summary-total">
          <div class="total-title">Total</div>
          <div class="total-value final-value" id="basket-total">130.00</div>
        </div>
        <div class="summary-checkout">
          <button class="checkout-cta">Go to Secure Checkout</button>
        </div>
      </div>
    </aside>
  </main>
</body>

</html>